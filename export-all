#!/bin/sh
set -euo pipefail

DRY_RUN=""
USE_STDLAYOUT=1

while [ $# -gt 0 ]; do
  case "$1" in
    -n|--dry-run)
      DRY_RUN=1
      shift
      ;;
    --nostdlayout)
      USE_STDLAYOUT=0
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Usage: export-all [--nostdlayout] [-n|--dry-run] EXPORTURL REMOTEURL DIR" >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
done

EXPORTURL=${1:-}
REMOTEURL=${2:-}
DIR=${3:-}
STAGING_DIR="${HOME}/repositories/staging"
DEST_DIR="${HOME}/repositories/github"

run() {
  if [ -n "${DRY_RUN}" ]; then
    echo "[dry-run] $*"
  else
    "$@"
  fi
}

run_in() {
  dir=$1
  shift
  if [ -n "${DRY_RUN}" ]; then
    echo "[dry-run] (cd ${dir} && $*)"
  else
    (cd "${dir}" && "$@")
  fi
}

if [ -z "${EXPORTURL}" ] || [ -z "${REMOTEURL}" ] || [ -z "${DIR}" ]; then
  echo "Usage: export-all [--nostdlayout] [-n|--dry-run] EXPORTURL REMOTEURL DIR" >&2
  exit 1
fi

echo "++++++++"

echo "*** Export URL: ${EXPORTURL}"
run mkdir -p "${STAGING_DIR}"
if [ ${USE_STDLAYOUT} -eq 1 ]; then
  run_in "${STAGING_DIR}" git svn clone --stdlayout "${EXPORTURL}" "${DIR}"
else
  run_in "${STAGING_DIR}" git svn clone "${EXPORTURL}" "${DIR}"
fi

echo "*** Adding origin: ${REMOTEURL}"
run_in "${STAGING_DIR}/${DIR}" git remote add origin "${REMOTEURL}"

echo "*** Doing initial push"
run_in "${STAGING_DIR}/${DIR}" git push -u origin master

echo "*** Finalizing local copies"
run mkdir -p "${DEST_DIR}"
run rm -rf "${DEST_DIR}/${DIR}"
run mv "${STAGING_DIR}/${DIR}" "${DEST_DIR}/"

echo "++++++++"
